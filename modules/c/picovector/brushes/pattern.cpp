#include "../brush.hpp"

namespace picovector {

  // embedded patterns
  const uint8_t patterns[38][8] = {
    {0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000,0b00000000},
    {0b00100010,0b00000000,0b10001000,0b00000000,0b00100010,0b00000000,0b10001000,0b00000000},
    {0b00100010,0b10001000,0b00100010,0b10001000,0b00100010,0b10001000,0b00100010,0b10001000},
    {0b01010101,0b10101010,0b01010101,0b10101010,0b01010101,0b10101010,0b01010101,0b10101010},
    {0b10101010,0b00000000,0b10101010,0b00000000,0b10101010,0b00000000,0b10101010,0b00000000},
    {0b01010101,0b01010101,0b01010101,0b01010101,0b01010101,0b01010101,0b01010101,0b01010101},
    {0b00010001,0b00100010,0b01000100,0b10001000,0b00010001,0b00100010,0b01000100,0b10001000},
    {0b01110111,0b01110111,0b01110111,0b01110111,0b01110111,0b01110111,0b01110111,0b01110111},
    {0b01001110,0b11001111,0b11111100,0b11100100,0b00100111,0b00111111,0b11110011,0b01110010},
    {0b01111111,0b11101111,0b11111101,0b11011111,0b11111110,0b11110111,0b10111111,0b11111011},
    {0b00000000,0b01110111,0b01110111,0b01110111,0b00000000,0b01110111,0b01110111,0b01110111},
    {0b00000000,0b01111111,0b01111111,0b01111111,0b00000000,0b11110111,0b11110111,0b11110111},
    {0b01111111,0b11111111,0b11111111,0b11111111,0b11111111,0b11111111,0b11111111,0b11111111},
    {0b01111111,0b10111111,0b11011111,0b11111111,0b11111101,0b11111011,0b11110111,0b11111111},
    {0b01111101,0b10111011,0b11000110,0b10111011,0b01111101,0b11111110,0b11111110,0b11111110},
    {0b00000111,0b10001011,0b11011101,0b10111000,0b01110000,0b11101000,0b11011101,0b10001110},
    {0b10101010,0b01011111,0b10111111,0b10111111,0b10101010,0b11110101,0b11111011,0b11111011},
    {0b11011111,0b10101111,0b01110111,0b01110111,0b01110111,0b01110111,0b11111010,0b11111101},
    {0b01000000,0b11111111,0b01000000,0b01000000,0b01001111,0b01001111,0b01001111,0b01001111},
    {0b11111111,0b11111111,0b11111111,0b11111111,0b11111111,0b11111111,0b11111111,0b11111111},
    {0b01111111,0b11111111,0b11110111,0b11111111,0b01111111,0b11111111,0b11110111,0b11111111},
    {0b01110111,0b11111111,0b11011101,0b11111111,0b01110111,0b11111111,0b11011101,0b11111111},
    {0b01110111,0b11011101,0b01110111,0b11011101,0b01110111,0b11011101,0b01110111,0b11011101},
    {0b01010101,0b11111111,0b01010101,0b11111111,0b01010101,0b11111111,0b01010101,0b11111111},
    {0b00000000,0b11111111,0b00000000,0b11111111,0b00000000,0b11111111,0b00000000,0b11111111},
    {0b11101110,0b11011101,0b10111011,0b01110111,0b11101110,0b11011101,0b10111011,0b01110111},
    {0b00000000,0b11111111,0b11111111,0b11111111,0b00000000,0b11111111,0b11111111,0b11111111},
    {0b11111110,0b11111101,0b11111011,0b11110111,0b11101111,0b11011111,0b10111111,0b01111111},
    {0b01010101,0b11111111,0b01111111,0b11111111,0b01110111,0b11111111,0b01111111,0b11111111},
    {0b00000000,0b01111111,0b01111111,0b01111111,0b01111111,0b01111111,0b01111111,0b01111111},
    {0b11110111,0b11100011,0b11011101,0b00111110,0b01111111,0b11111110,0b11111101,0b11111011},
    {0b01110111,0b11101011,0b11011101,0b10111110,0b01110111,0b11111111,0b01010101,0b11111111},
    {0b10111111,0b01011111,0b11111111,0b11111111,0b11111011,0b11110101,0b11111111,0b11111111},
    {0b11111100,0b01111011,0b10110111,0b11001111,0b11110011,0b11111101,0b11111110,0b11111110},
    {0b01111111,0b01111111,0b10111110,0b11000001,0b11110111,0b11110111,0b11101011,0b00011100},
    {0b11101111,0b11011111,0b10101011,0b01010101,0b00000000,0b11111101,0b11111011,0b11110111},
    {0b10001000,0b01110110,0b01110000,0b01110000,0b10001000,0b01100111,0b00000111,0b00000111},
    {0b11111111,0b11110111,0b11101011,0b11010101,0b10101010,0b11010101,0b11101011,0b11110111}
  };

  void pattern_brush_span_func(image_t *target, brush_t *brush, int x, int y, int w) {
    pattern_brush_t *p = (pattern_brush_t*)brush;
    uint32_t *dst = (uint32_t*)target->ptr(x, y);
    blend_func_t fn = target->_blend_func;

    uint32_t c1c[4] = {_r(p->c1._p), _g(p->c1._p), _b(p->c1._p), _a(p->c1._p)};
    uint32_t c2c[4] = {_r(p->c2._p), _g(p->c2._p), _b(p->c2._p), _a(p->c2._p)};

    while(w--) {
      uint8_t u = 7 - (x & 0b111);
      uint8_t v = y & 0b111;
      uint8_t bit = p->p[v];

      uint32_t *src = bit & (1 << u) ? c1c : c2c;

      uint32_t r = src[0];
      uint32_t g = src[1];
      uint32_t b = src[2];
      uint32_t a = src[3];

      *dst = fn(*dst, r, g, b, a);
      dst++;
      x++;
    }
  }

  void pattern_brush_masked_span_func(image_t *target, brush_t *brush, int x, int y, int w, uint8_t *mask) {
    pattern_brush_t *p = (pattern_brush_t*)brush;
    uint32_t *dst = (uint32_t*)target->ptr(x, y);
    blend_func_t fn = target->_blend_func;

    uint32_t c1c[4] = {_r(p->c1._p), _g(p->c1._p), _b(p->c1._p), _a(p->c1._p)};
    uint32_t c2c[4] = {_r(p->c2._p), _g(p->c2._p), _b(p->c2._p), _a(p->c2._p)};

    while(w--) {
      uint8_t u = 7 - (x & 0b111);
      uint8_t v = y & 0b111;
      uint8_t bit = p->p[v];

      uint32_t *src = bit & (1 << u) ? c1c : c2c;

      uint32_t m = *mask;
      uint32_t r = (src[0] * m + 128) >> 8;
      uint32_t g = (src[1] * m + 128) >> 8;
      uint32_t b = (src[2] * m + 128) >> 8;
      uint32_t a = (src[3] * m + 128) >> 8;

      *dst = fn(*dst, r, g, b, a);
      dst++;
      x++;
      mask++;
    }
  }

  pattern_brush_t::pattern_brush_t(const color_t& c1, const color_t& c2, uint8_t pattern_index) : c1(c1), c2(c2) {
    memcpy(this->p, &patterns[pattern_index], sizeof(uint8_t) * 8);
  }

  pattern_brush_t::pattern_brush_t(const color_t& c1, const color_t& c2, uint8_t *pattern) : c1(c1), c2(c2) {
    memcpy(this->p, pattern, sizeof(uint8_t) * 8);
  }

  span_func_t pattern_brush_t::span_func() {
    return pattern_brush_span_func;
  }

  masked_span_func_t pattern_brush_t::masked_span_func() {
    return pattern_brush_masked_span_func;
  }

}